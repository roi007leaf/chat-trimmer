<div class="chat-archive-viewer">
    <div class="archive-header">
        <h2>{{localize "CHATTRIMMER.ArchiveViewer.Title"}}</h2>
        <div class="archive-header-controls">
            <select class="archive-select" name="session">
                {{#each sessionOptions}}
                <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>
                    {{this.label}}
                </option>
                {{/each}}
            </select>
            <button type="button" class="delete-current-archive" data-action="deleteCurrentArchive" data-tooltip="{{localize 'CHATTRIMMER.Buttons.DeleteCurrentArchive'}}">
                <i class="fas fa-trash"></i>
            </button>
            <button type="button" class="delete-all-archives" data-action="deleteAllArchives" data-tooltip="{{localize 'CHATTRIMMER.Buttons.DeleteAllArchives'}}">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    </div>

    {{#if showArchiveBody}}
    <div class="archive-body">
        {{#if sessionSummary}}
        <div class="session-summary">
            <div class="summary-header" data-action="toggleSummary">
                <h3>{{sessionSummary.sessionName}} Summary</h3>
                <i class="fas fa-chevron-down toggle-icon {{#if summaryCollapsed}}collapsed{{/if}}"></i>
            </div>
            <div class="summary-content {{#if summaryCollapsed}}collapsed{{/if}}">
            <div class="summary-grid">
                <div class="summary-section">
                    <h4>Session Info</h4>
                    <ul>
                        <li><strong>Duration:</strong> {{sessionSummary.duration}}</li>
                        <li><strong>Date:</strong> {{sessionSummary.archiveDate}}</li>
                        <li><strong>Messages:</strong> {{sessionSummary.totalMessages}}</li>
                    </ul>
                </div>
                <div class="summary-section">
                    <h4>Participants</h4>
                    <ul>
                        {{#each sessionSummary.participants}}
                        <li>{{this}}</li>
                        {{/each}}
                    </ul>
                </div>
                <div class="summary-section">
                    <h4>Statistics</h4>
                    <ul>
                        <li><strong>Combats:</strong> {{sessionSummary.statistics.combats}}</li>
                        <li><strong>Rolls:</strong> {{sessionSummary.statistics.rolls}}</li>
                        <li><strong>Critical Successes:</strong> {{sessionSummary.statistics.criticalSuccesses}}</li>
                        <li><strong>Critical Failures:</strong> {{sessionSummary.statistics.criticalFails}}</li>
                    </ul>
                </div>
            </div>
            <div class="summary-section key-events">
                <h4>Key Events</h4>
                {{#if sessionSummary.keyEvents.length}}
                <ul>
                    {{#each sessionSummary.keyEvents}}
                    <li class="key-event {{this.eventType}}" data-action="viewKeyEvent" data-entry-id="{{this.entryId}}">
                        <span class="event-icon">{{this.icon}}</span>
                        <span class="event-time">{{formatTime this.timestamp}}</span>
                        <span class="event-text">{{this.text}}</span>
                    </li>
                    {{/each}}
                </ul>
                {{else}}
                <p style="color: var(--color-text-dark-inactive); font-style: italic; padding: 0.5rem;">No significant events detected in this session.</p>
                {{/if}}
            </div>
            </div>
        </div>
        {{/if}}

        <div class="archive-controls">
            {{#if (eq viewMode "full")}}
            <div class="filter-group">
                <label>{{localize "CHATTRIMMER.ArchiveViewer.Filter"}}:</label>
                <select class="category-filter" name="filter">
                    <option value="all" {{#if (eq currentFilter "all")}}selected{{/if}}>
                        {{localize "CHATTRIMMER.Categories.All"}}
                    </option>
                    <option value="combat" {{#if (eq currentFilter "combat")}}selected{{/if}}>
                        ‚öîÔ∏è {{localize "CHATTRIMMER.Categories.Combat"}}
                    </option>
                    <option value="rolls" {{#if (eq currentFilter "rolls")}}selected{{/if}}>
                        üé≤ {{localize "CHATTRIMMER.Categories.Rolls"}}
                    </option>
                    <option value="speech" {{#if (eq currentFilter "speech")}}selected{{/if}}>
                        üí¨ {{localize "CHATTRIMMER.Categories.Speech"}}
                    </option>
                    <option value="emotes" {{#if (eq currentFilter "emotes")}}selected{{/if}}>
                        ‚ú® {{localize "CHATTRIMMER.Categories.Emotes"}}
                    </option>
                    <option value="whispers" {{#if (eq currentFilter "whispers")}}selected{{/if}}>
                        üí≠ {{localize "CHATTRIMMER.Categories.Whispers"}}
                    </option>
                    <option value="healing" {{#if (eq currentFilter "healing")}}selected{{/if}}>
                        ‚ù§Ô∏è {{localize "CHATTRIMMER.Categories.Healing"}}
                    </option>
                    <option value="items" {{#if (eq currentFilter "items")}}selected{{/if}}>
                        üì¶ {{localize "CHATTRIMMER.Categories.Items"}}
                    </option>
                    <option value="important" {{#if (eq currentFilter "important")}}selected{{/if}}>
                        ‚≠ê {{localize "CHATTRIMMER.Categories.Important"}}
                    </option>
                    <option value="system" {{#if (eq currentFilter "system")}}selected{{/if}}>
                        üìù {{localize "CHATTRIMMER.Categories.System"}}
                    </option>
                </select>
            </div>

            <div class="search-group">
                <input
                    type="text"
                    class="archive-search"
                    placeholder="{{localize 'CHATTRIMMER.ArchiveViewer.Search'}}"
                    value="{{searchQuery}}"
                    name="search"
                />
            </div>
            {{/if}}
        </div>

        {{#if (eq viewMode "full")}}
        <div class="archive-entries">
            {{#each filteredEntries}}
            <div class="archive-entry {{this.category}}" data-entry-id="{{this.id}}">
                <span class="entry-icon">{{this.icon}}</span>
                <div class="entry-header-content">
                    {{#if this.speaker}}<div class="entry-speaker">{{this.speaker}}</div>{{/if}}
                    <span class="entry-summary">{{#if this.displaySummary}}{{removeDuplicateSpeaker this.displaySummary this.speaker}}{{else}}{{removeDuplicateSpeaker this.displayText this.speaker}}{{/if}}</span>
                </div>
                <span class="entry-timestamp">{{formatTime this.timestamp}}</span>
                <button class="view-original-btn" data-action="viewOriginal" data-tooltip="View Original">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            {{else}}
            <div class="no-entries">
                <p>{{localize "CHATTRIMMER.ArchiveViewer.NoEntries"}}</p>
            </div>
            {{/each}}
        </div>

        {{#if (gt totalPages 1)}}
        <div class="archive-pagination">
            <div class="pagination-info">
                Showing {{pageStart}}-{{pageEnd}} of {{totalFilteredEntries}} entries
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" data-action="firstPage" {{#unless hasPrevPage}}disabled{{/unless}} data-tooltip="First Page">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="pagination-btn" data-action="prevPage" {{#unless hasPrevPage}}disabled{{/unless}} data-tooltip="Previous Page">
                    <i class="fas fa-angle-left"></i>
                </button>
                <span class="pagination-page">Page {{currentPage}} / {{totalPages}}</span>
                <button class="pagination-btn" data-action="nextPage" {{#unless hasNextPage}}disabled{{/unless}} data-tooltip="Next Page">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="pagination-btn" data-action="lastPage" {{#unless hasNextPage}}disabled{{/unless}} data-tooltip="Last Page">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        </div>
        {{/if}}
        {{/if}}
    </div>
    {{else}}
    <div class="no-archive">
        <p>{{localize "CHATTRIMMER.ArchiveViewer.NoArchives"}}</p>
    </div>
    {{/if}}
</div>
